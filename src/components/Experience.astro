---
import Title from './ui/Title.astro';

interface Props {
  projects: Project[];
}

interface Project {
  title: string;
  company: string;
  date: string;
  responsabilities: string[];
}

const { projects } = Astro.props;

---


<section class="relative py-10 bg-[#13151A]" id="experience">
  <Title title='Experience'/>
  <div class="flex flex-row justify-center gap-6">
    
<ol class="relative flex flex-col gap-8 border-l-2 border-pink-400/40 pl-6 w-[80%]">
  {projects.map(project => (
    <li>
      <div
        class="relative bg-[#50586e] p-px rounded-lg
        bg-linear-to-br from-transparent via-pink-500/40 to-cyan-400/40"
      >
        <div class="experience-item bg-[#13151a] rounded-lg p-5 relative">

          <!-- DOT -->
          <div class="dot absolute -left-8 top-6 w-3 h-3 rounded-full bg-pink-400"></div>

          <!-- HEADER -->
          <div class="header-container toggle-btn cursor-pointer">
            <div>
              <h3 class="text-white font-semibold pb-1">
                {project.title}
              </h3>
              <h4 class="text-gray-300 font-medium pb-1">
                {project.company}
              </h4>
              <time class="text-gray-400 text-sm">
                {project.date}
              </time>
            </div>
          </div>

          <!-- COLLAPSE -->
          <div class="collapse max-h-0 overflow-hidden transition-all duration-300">
           <ul class="list-disc list-inside text-white space-y-1 pl-5 pt-3">
  {project.responsabilities.map(responsability => (
    <li>{responsability}</li>
  ))}
</ul>
          </div>

        </div>
      </div>
    </li>
  ))}
</ol>

  </div>
</section>

<script>
  interface ExperienceItem extends HTMLElement {}

  interface DotElement extends HTMLElement {}

  interface ToggleButtonElement extends HTMLElement {}

  interface CollapseElement extends HTMLElement {}

  interface ExperienceIntersectionEntry extends IntersectionObserverEntry {
    target: ExperienceItem;
  }

  class DotObserver {
    private observer: IntersectionObserver;

    constructor(private items: NodeListOf<ExperienceItem>) {
      this.observer = new IntersectionObserver(
        (entries) => this.handleIntersection(entries),
        { threshold: 0.5 }
      );
      this.init();
    }

    private handleIntersection(entries: ExperienceIntersectionEntry[]): void {
      entries.forEach((entry: ExperienceIntersectionEntry) => {
        const dot = entry.target.querySelector(".dot") as DotElement | null;
        if (dot) {
          if (entry.isIntersecting) {
            dot.classList.add("bg-pink-400");
          } else {
            dot.classList.remove("bg-pink-400");
          }
        }
      });
    }

    private init(): void {
      this.items.forEach((item: ExperienceItem) => this.observer.observe(item));
    }
  }

  class CollapseToggle {
    private btn: ToggleButtonElement;
    private col: CollapseElement;

    constructor(button: ToggleButtonElement, collapseElement: CollapseElement) {
      this.btn = button;
      this.col = collapseElement;
      this.btn.addEventListener("click", () => this.toggle());
    }

    private toggle(): void {
      this.col.classList.remove("collapse");

      if (this.col.classList.contains("open")) {
        this.close();
      } else {
        this.open();
      }
    }

    private close(): void {
      this.col.style.maxHeight = `${this.col.scrollHeight}px`;
      requestAnimationFrame(() => {
        this.col.style.maxHeight = "0px";
      });
      this.col.classList.remove("open");
    }

    private open(): void {
      this.col.style.maxHeight = "none";
      const height = `${this.col.scrollHeight}px`;
      this.col.style.maxHeight = "0px";
      requestAnimationFrame(() => {
        this.col.style.maxHeight = height;
        this.col.classList.add("open");

        this.col.addEventListener(
          "transitionend",
          () => {
            if (this.col.classList.contains("open")) {
              this.col.style.maxHeight = "none";
            }
          },
          { once: true }
        );
      });
    }
  }

  const items = document.querySelectorAll(
    ".experience-item"
  ) as NodeListOf<ExperienceItem>;

  new DotObserver(items);

  items.forEach((item: ExperienceItem) => {
    const btn = item.querySelector(".toggle-btn") as ToggleButtonElement | null;
    const col = item.querySelector(".collapse") as CollapseElement | null;

    if (btn && col) {
      new CollapseToggle(btn, col);
    }
  });
</script>
